"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("lodash/merge")),r=e(require("ra-data-graphql")),n=require("ra-core"),i=require("graphql"),o=e(require("graphql-tag")),a=require("aws-appsync"),u=require("apollo-client"),c=require("apollo-link-http"),s=require("apollo-cache-inmemory"),l=require("react"),d=e(l),f=e(require("@aws-amplify/auth")),p=require("@aws-amplify/core"),m=require("aws-appsync-auth-link"),y=require("aws-amplify"),v=require("@material-ui/core"),E=e(require("@material-ui/icons/ChevronLeft")),h=e(require("@material-ui/icons/ChevronRight")),g=e(require("@material-ui/core/Toolbar")),T=require("react-redux"),A=require("react-admin"),P=e(require("@material-ui/icons/ImageRounded")),_=e(require("@material-ui/icons/MovieRounded")),k=e(require("@material-ui/icons/DescriptionRounded")),S=require("uuidv4");function I(){return(I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function b(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)t.indexOf(r=o[n])>=0||(i[r]=e[r]);return i}var N,O,w=function e(t){return(null==t?void 0:t.kind)===i.TypeKind.NON_NULL||(null==t?void 0:t.kind)===i.TypeKind.LIST?e(t.ofType):t},q=function(e){var t=["key","level","identityId","region","bucket"];return Object.entries(e).reduce((function(e,r){var n=r[0],i=r[1];return t.includes(n)&&(e[n]=i),e}),{})},x=function e(t){return Object.keys(t).reduce((function(r,n){var i;if(n.startsWith("_"))return r;var o,a,u,c,s=t[n];return null==s?r:Array.isArray(s)?I({},r,"object"==typeof s[0]?((o={})[n]=s.map(e),o[n+"Ids"]=s.map((function(e){return e.id})),o):((a={})[n]=s,a)):"object"==typeof s?I({},r,s&&s.id&&((u={})[n+".id"]=s.id,u),((c={})[n]=e(s),c)):I({},r,((i={})[n]=s,i))}),{})},j=function(e,t,r){return function(e){var t=e.queries,r=e.mutations;return function(e){var i=e.resources.map((function(e){return e.type.name}));return function(a,u,c){var s=e.resources.find((function(e){return e.type.name===u}));if(!s)throw new Error("Unknown resource "+u+". Make sure it has been declared on your server side schema. Known resources are "+i.join(", "));var l=s[a];if(!l)throw new Error("No query or mutation matching fetch type "+a+" could be found for resource "+s.type.name);var d=function(e){return function(t,r,i,o){var a,u=function e(t,r,n){var i={};return t?(Object.keys(t).forEach((function(o){try{var a=t[o],u=null;if(!a)return i[o]=a,Promise.resolve();if(r&&Array.isArray(r.args)&&(u=r.args.find((function(e){return e.name===o}))),a instanceof File||"rawFile"===o)return Promise.resolve();if(a instanceof Date)return i[o]=a.toISOString(),Promise.resolve();if(a instanceof Object&&!Array.isArray(a)&&u&&"INPUT_OBJECT"===u.type.kind){var c=n.types.find((function(e){return e.kind===u.type.kind&&e.name===u.type.name})).inputFields;return i[o]=e(a,{args:c},n),Promise.resolve()}return a instanceof Object&&!a instanceof Date&&!Array.isArray(a)?(i[o]=e(a,r,n),Promise.resolve()):u?(i[o]=function(e,t){switch(t.kind+":"+t.name){case"SCALAR:Int":return Number(e);case"SCALAR:String":return String(e);case"SCALAR:Boolean":return Boolean(e);default:return e}}(a,u.type),Promise.resolve()):(i[o]=a,Promise.resolve())}catch(e){return Promise.reject(e)}})),i):t}(i,o,e);switch(r){case n.GET_LIST:return function(e,t,r){var n=(r.filter||{}).nextToken,i=r.pagination||{};return{limit:i.perPage,nextToken:n&&i.page>1?n:void 0}}(0,0,u);case n.GET_MANY:return u.ids.reduce((function(e,t,r){return e["id"+r]=t,e}),{});case n.GET_MANY_REFERENCE:var c=e.queries.find((function(e){return e.name===i.target}));if(!c)throw Error("Couldn't find a query for "+i.target+". Did you forget to add a param queryField to your @key directive for "+i.target+"? See https://github.com/mayteio/ra-aws-amplify#a-post-with-comments-using-the-referencemanyfield-");return(a={limit:u.pagination.perPage})[c.args[0].name]=u.id,a;case n.GET_ONE:return{id:u.id};case n.DELETE:return{input:{id:u.id}};case n.CREATE:case n.UPDATE:return function(e){return function(t,r,n,i){var o=i.args.find((function(e){return"input"===e.name})),a=w(o.type),u=e.types.find((function(e){return e.name===a.name})).inputFields;return{input:Object.keys(n.data).reduce((function(e,t){var r,i,o=u.find((function(e){return e.name===t}));if(!o||!u.find((function(e){return e.name===o.name})))return e;if(null===(r=w(o.type).name)||void 0===r?void 0:r.match(/S3Object/i)){var a,c=Array.isArray(n.data[t])?n.data[t].map(q):q(n.data[t]);return I({},e,((a={})[t]=c,a))}return I({},e,((i={})[t]=n.data[t],i))}),{})}}}(e)(t,r,u,o)}}}(e)(s,a,c,l);return{query:function(e,t,r,i,a){switch(e){case n.GET_LIST:return o(i["list"+t.type.name+"s"]);case n.GET_ONE:return o(i["get"+t.type.name]);case n.GET_MANY_REFERENCE:return o(i[r.target]);case n.CREATE:return o(a["create"+t.type.name]);case n.UPDATE:return o(a["update"+t.type.name]);case n.DELETE:return o(a["delete"+t.type.name]);default:return}}(a,s,c,t,r),variables:d,parseResponse:function(e,t,r,i){return function(o){var a=o.data;return e===n.GET_LIST?{data:a["list"+t.type.name+"s"].items.map(x),nextToken:a["list"+t.type.name+"s"].nextToken,total:9999}:e===n.GET_MANY_REFERENCE?{data:a[i.target]&&a[i.target].items.map(x),nextToken:a[i.target].nextToken,total:9999}:{data:a[r.name]&&x(a[r.name]),total:9999}}}(a,s,l,c)}}}}}(),C=((N={})[n.GET_MANY]=n.GET_ONE,N[n.UPDATE_MANY]=n.UPDATE,N[n.DELETE_MANY]=n.DELETE,N),R={introspection:{operationNames:(O={},O[n.GET_LIST]=function(e){return"list"+e.name+"s"},O[n.GET_ONE]=function(e){return"get"+e.name},O[n.GET_MANY]=function(e){return"list"+e.name+"s"},O[n.GET_MANY_REFERENCE]=function(e){return"list"+e.name+"s"},O[n.CREATE]=function(e){return"create"+e.name},O[n.UPDATE]=function(e){return"update"+e.name},O[n.DELETE]=function(e){return"delete"+e.name},O),exclude:void 0,include:void 0}},L=function(e){var i=e.queries,o=e.mutations,l=e.schema,d=b(e,["queries","mutations","schema"]),f=function(e){var t=e.auth,r=c.createHttpLink({uri:e.endpoint}),n=a.createAppSyncLink(t),i=new s.IntrospectionFragmentMatcher({introspectionQueryResultData:{__schema:{types:[]}}});return new u.ApolloClient({link:n.concat(r),cache:new s.InMemoryCache({fragmentMatcher:i})})}(I({},d)),p=j({queries:i,mutations:o,schema:l}),m=t({client:f,buildQuery:p},R,d,{introspection:{schema:l.data.__schema}});return r(m).then((function(e){return function(t,r,i){var o=b(i,["ids"]);switch(t){case n.DELETE_MANY:return Promise.all(i.ids.map((function(n){return e(C[t],r,I({id:n},o))}))).then((function(e){return{data:e.reduce((function(e,t,r){return[].concat(e,[i.ids[r]])}),[])}}));case n.UPDATE_MANY:case n.GET_MANY:return Promise.all(i.ids.map((function(n){return e(C[t],r,I({id:n},o))}))).then((function(e){return{data:t===n.GET_MANY?e.map((function(e){return e.data})):e.reduce((function(e,t){return[].concat(e,[t.data.id])}),[])}}));default:return e(t,r,i)}}}))};function D(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var U=d.createContext(void 0),Y=d.createContext(void 0);function M(){return l.useContext(Y)}var G=function(e,t){return void 0===e&&(e=null),t.type===A.CRUD_GET_LIST_SUCCESS?t.payload.nextToken||null:e},F=function(e){var t=e.source,r=e.record,n=void 0===r?{}:r,i=e.children,o=b(e,["source","record","children"]),a=d.useState(),u=a[0],c=a[1],s=t&&"object"==typeof n[t]?n[t]:n,l=s.key,f=s.identityId,p=s.level;if(d.useEffect((function(){l&&!l.match(/blob|http/i)&&y.Storage.get(l,"protected"===p||"private"===p?{level:p,identityId:f}:{}).then((function(e){return c(e)}))}),[l,p,f]),!u&&l)return d.createElement(v.CircularProgress,{"data-testid":"s3-object-loading"});if(u){var m=I({record:n,source:t,src:u},o);return d.cloneElement(i,m)}return null};F.defaultProps={addLabel:!0};var H=v.makeStyles((function(e){return{icon:{marginRight:e.spacing(1)}}})),K=function(e){var t=e.record,r=e.source,n=t&&r&&t[r]||t,i=function(e){switch(e){case"image/png":case"image/gif":case"image/jpeg":case"image/jpg":return P;case"video/mp4":case"video/3gpp":case"video/quicktime":case"video/x-msvideo":return _;default:return k}}(n.type),o=H();return d.createElement(d.Fragment,null,d.createElement(i,{titleAccess:"Icon for file type "+(n.type||"unknown"),className:o.icon}),d.createElement(v.Link,{href:n.key,title:"Open "+n.key,target:"_blank"},n.key+(n.level?" - "+n.level:"")))},B=function(e){return d.createElement(F,Object.assign({},e),d.createElement(K,null))},z=function(e){var t=e.src,r=e.record,n=e.source,i=r&&n&&r[n]||r;return i&&t?d.createElement("img",Object.assign({src:t,title:i.key},e.imgProps)):null},J=function(e){var t=e.imgProps,r=void 0===t?{}:t,n=b(e,["imgProps"]);return d.createElement(F,Object.assign({},n),d.createElement(z,{imgProps:r}))};J.defaultProps={addLabel:!0};var Q=function(e){var t=e.source,r=e.dropzoneOptions,n=void 0===r?{}:r,i=e.level,o=e.children,a=b(e,["source","dropzoneOptions","level","children"]),u=A.usePermissions().permissions,c=A.useInput({source:t}).input,s=A.useNotify(),l=I({source:t,options:I({onDrop:function(e){try{var t=D((function(){return Promise.resolve(Promise.all(e.map((function(e){var t=e.name.split(".");return y.Storage.put(t[0]+"-"+S.uuid().split("-").slice(0,2).join("-")+"."+t[1],e).then((function(t){var r={key:t.key,type:e.type,level:null,identityId:null};return"protected"!==i&&"private"!==i||(r.identityId=u.claims.identityId,r.level=i),r}))})))).then((function(e){c.onChange(a.multiple?e:e[0])}))}),(function(){c.onChange(void 0),s("There was an error uploading your files.")}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}},n)},a);return d.cloneElement(o,l)},Z=v.makeStyles({fileInput:{"& .previews > div":{display:"flex",alignItems:"center"}}}),V={nextToken:G};exports.AmplifyAuthProvider=function(e){var t=e.children,r=l.useState(void 0),n=r[0],i=r[1];return l.useEffect((function(){!function(){try{var e=D((function(){return Promise.resolve(f.currentAuthenticatedUser()).then((function(e){i("not authenticated"===e?void 0:e)}))}),(function(){}));e&&e.then&&e.then((function(){}))}catch(e){Promise.reject(e)}}();var e=function(e){var t=e.payload;try{var r=function(){if("signIn"===t.event){var e=D((function(){return Promise.resolve(f.currentAuthenticatedUser()).then((function(e){i(e)}))}),(function(){}));if(e&&e.then)return e.then((function(){}))}else"signOut"===t.event&&i(void 0)}();return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}};return p.Hub.listen("auth",e),function(){p.Hub.remove("auth",e)}}),[]),d.createElement(U.Provider,{value:f},d.createElement(Y.Provider,{value:n},t))},exports.AmplifyPagination=function(e){var t=T.useSelector((function(e){return e.nextToken}));return 1!==e.page||t?d.createElement(g,null,e.page>1&&d.createElement(v.Button,{color:"primary",key:"prev",startIcon:d.createElement(E,null),onClick:function(){return e.setPage(e.page-1)}},"Prev"),t&&d.createElement(v.Button,{color:"primary",key:"next",endIcon:d.createElement(h,null),onClick:function(){e.setPage(e.page+1),e.setNextToken(t)}},"Next")):null},exports.NOT_INSIDE_AMPLIFY_PROVIDER="No AuthenticationContext. Did you forget to wrap your app in <AmplifyProvider />?",exports.S3Field=F,exports.S3FileField=B,exports.S3FileInput=function(e){var t=Z();return d.createElement(Q,Object.assign({},e),d.createElement(A.FileInput,{className:t.fileInput},d.createElement(B,{source:e.source})))},exports.S3ImageField=J,exports.S3ImageInput=function(e){return d.createElement(Q,Object.assign({},e),d.createElement(A.ImageInput,null,d.createElement(J,{source:e.source})))},exports.S3Input=Q,exports.buildAmplifyProvider=L,exports.nextTokenReducer=G,exports.reducers=V,exports.useAmplifyDataProvider=function(e){var t=e.config,r=e.schema,n=e.queries,i=e.mutations,o=e.authType,a=void 0===o?void 0:o,u=l.useState(),c=u[0],s=u[1],d=M(),f=a||t.aws_appsync_authenticationType;return l.useEffect((function(){(function(e){try{var o=function(e,t){switch(t||e.aws_appsync_authenticationType||m.AUTH_TYPE.NONE){case m.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS:return{type:m.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS,jwtToken:function(){try{return Promise.resolve(D((function(){return Promise.resolve(y.Auth.currentSession()).then((function(e){return e.getAccessToken().getJwtToken()}))}),(function(e){return console.log("error with jwt",e),Promise.reject("Unauthorized")})))}catch(e){return Promise.reject(e)}}};case m.AUTH_TYPE.API_KEY:return{type:m.AUTH_TYPE.API_KEY,apiKey:e.aws_appsync_apiKey};case m.AUTH_TYPE.NONE:default:return{type:m.AUTH_TYPE.NONE}}}(t,e);return Promise.resolve(L({endpoint:t.aws_appsync_graphqlEndpoint,auth:{url:t.aws_appsync_graphqlEndpoint,region:t.aws_appsync_region,auth:o},schema:r,queries:n,mutations:i}))}catch(e){return Promise.reject(e)}})(f).then((function(e){return s((function(){return e}))}))}),[d,f]),c},exports.useAuth=function(){var e=l.useContext(U);if(!e)throw Error("No AuthenticationContext. Did you forget to wrap your app in <AmplifyProvider />?");return e},exports.useAuthProvider=function(){return{login:function(e){var t=e.username,r=e.password,n=e.provider;return t&&r&&!n?f.signIn(t,r):f.federatedSignIn({provider:n})},logout:function(){return f.signOut()},checkAuth:function(){return f.currentSession()},checkError:function(){return f.currentCredentials()},getPermissions:function(){return Promise.all([f.currentSession(),f.currentCredentials()]).then((function(e){var t=e[1].identityId;return{claims:I({},e[0].getIdToken().payload,{identityId:t})}}))}}},exports.useUser=M;
//# sourceMappingURL=ra-aws-amplify.cjs.production.min.js.map
