"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=e(require("lodash/merge")),t=e(require("ra-data-graphql")),n=require("ra-core"),i=require("graphql"),o=e(require("graphql-tag")),a=require("aws-appsync"),u=require("apollo-client"),c=require("apollo-link-http"),s=require("apollo-cache-inmemory"),l=require("react"),d=e(l),f=e(require("@aws-amplify/auth")),p=require("@aws-amplify/core"),m=require("aws-appsync-auth-link"),y=require("aws-amplify"),v=require("@material-ui/core"),E=e(require("@material-ui/icons/ChevronLeft")),h=e(require("@material-ui/icons/ChevronRight")),g=e(require("@material-ui/core/Toolbar")),T=require("react-redux"),A=require("react-admin"),P=e(require("@material-ui/icons/ImageRounded")),_=e(require("@material-ui/icons/MovieRounded")),k=e(require("@material-ui/icons/DescriptionRounded")),S=require("uuidv4");function I(){return(I=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function b(e,r){if(null==e)return{};var t,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r.indexOf(t=o[n])>=0||(i[t]=e[t]);return i}var N,O,w=function e(r){return(null==r?void 0:r.kind)===i.TypeKind.NON_NULL||(null==r?void 0:r.kind)===i.TypeKind.LIST?e(r.ofType):r},q=function(e){var r=["key","level","identityId","region","bucket"];return Object.entries(e).reduce((function(e,t){var n=t[0],i=t[1];return r.includes(n)&&(e[n]=i),e}),{})},x=function e(r){return Object.keys(r).reduce((function(t,n){var i;if(n.startsWith("_"))return t;var o,a,u,c,s=r[n];return null==s?t:Array.isArray(s)?I({},t,"object"==typeof s[0]?((o={})[n]=s.map(e),o[n+"Ids"]=s.map((function(e){return e.id})),o):((a={})[n]=s,a)):"object"==typeof s?I({},t,s&&s.id&&((u={})[n+".id"]=s.id,u),((c={})[n]=e(s),c)):I({},t,((i={})[n]=s,i))}),{})},C=function(e,r,t){return function(e){var r=e.queries,t=e.mutations;return function(e){var i=e.resources.map((function(e){return e.type.name}));return function(a,u,c){console.log(a,u,c);var s=e.resources.find((function(e){return e.type.name===u}));if(!s)throw new Error("Unknown resource "+u+". Make sure it has been declared on your server side schema. Known resources are "+i.join(", "));var l=s[a];if(!l)throw new Error("No query or mutation matching fetch type "+a+" could be found for resource "+s.type.name);var d=function(e){return function(r,t,i,o){var a,u=function e(r,t,n){var i={};return r?(Object.keys(r).forEach((function(o){try{var a=r[o],u=null;if(!a)return i[o]=a,Promise.resolve();if(t&&Array.isArray(t.args)&&(u=t.args.find((function(e){return e.name===o}))),a instanceof File||"rawFile"===o)return Promise.resolve();if(a instanceof Date)return i[o]=a.toISOString(),Promise.resolve();if(a instanceof Object&&!Array.isArray(a)&&u&&"INPUT_OBJECT"===u.type.kind){var c=n.types.find((function(e){return e.kind===u.type.kind&&e.name===u.type.name})).inputFields;return i[o]=e(a,{args:c},n),Promise.resolve()}return a instanceof Object&&!a instanceof Date&&!Array.isArray(a)?(i[o]=e(a,t,n),Promise.resolve()):u?(i[o]=function(e,r){switch(r.kind+":"+r.name){case"SCALAR:Int":return Number(e);case"SCALAR:String":return String(e);case"SCALAR:Boolean":return Boolean(e);default:return e}}(a,u.type),Promise.resolve()):(i[o]=a,Promise.resolve())}catch(e){return Promise.reject(e)}})),i):r}(i,o,e);switch(t){case n.GET_LIST:return function(e,r,t){console.log("params: ",t);var n=(t.filter||{}).nextToken||void 0;return console.log("nextToken: ",n),{nextToken:n}}(0,0,u);case n.GET_MANY:return u.ids.reduce((function(e,r,t){return e["id"+t]=r,e}),{});case n.GET_MANY_REFERENCE:var c=e.queries.find((function(e){return e.name===i.target}));if(!c)throw Error("Couldn't find a query for "+i.target+". Did you forget to add a param queryField to your @key directive for "+i.target+"? See https://github.com/mayteio/ra-aws-amplify#a-post-with-comments-using-the-referencemanyfield-");return(a={limit:u.pagination.perPage})[c.args[0].name]=u.id,a;case n.GET_ONE:return{id:u.id};case n.DELETE:return{input:{id:u.id}};case n.CREATE:case n.UPDATE:return function(e){return function(r,t,n,i){var o=i.args.find((function(e){return"input"===e.name})),a=w(o.type),u=e.types.find((function(e){return e.name===a.name})).inputFields;return{input:Object.keys(n.data).reduce((function(e,r){var t,i,o=u.find((function(e){return e.name===r}));if(!o||!u.find((function(e){return e.name===o.name})))return e;if(null===(t=w(o.type).name)||void 0===t?void 0:t.match(/S3Object/i)){var a,c=Array.isArray(n.data[r])?n.data[r].map(q):q(n.data[r]);return I({},e,((a={})[r]=c,a))}return I({},e,((i={})[r]=n.data[r],i))}),{})}}}(e)(r,t,u,o)}}}(e)(s,a,c,l);return{query:function(e,r,t,i,a){switch(e){case n.GET_LIST:return o(i["list"+r.type.name+"s"]);case n.GET_ONE:return o(i["get"+r.type.name]);case n.GET_MANY_REFERENCE:return o(i[t.target]);case n.CREATE:return o(a["create"+r.type.name]);case n.UPDATE:return o(a["update"+r.type.name]);case n.DELETE:return o(a["delete"+r.type.name]);default:return}}(a,s,c,r,t),variables:d,parseResponse:function(e,r,t,i){return function(o){var a=o.data;return e===n.GET_LIST?{data:a["list"+r.type.name+"s"].items.map(x),nextToken:a["list"+r.type.name+"s"].nextToken,total:9999}:e===n.GET_MANY_REFERENCE?{data:a[i.target]&&a[i.target].items.map(x),nextToken:a[i.target].nextToken,total:9999}:{data:a[t.name]&&x(a[t.name]),total:9999}}}(a,s,l,c)}}}}}(),j=((N={})[n.GET_MANY]=n.GET_ONE,N[n.UPDATE_MANY]=n.UPDATE,N[n.DELETE_MANY]=n.DELETE,N),R={introspection:{operationNames:(O={},O[n.GET_LIST]=function(e){return"list"+e.name+"s"},O[n.GET_ONE]=function(e){return"get"+e.name},O[n.GET_MANY]=function(e){return"list"+e.name+"s"},O[n.GET_MANY_REFERENCE]=function(e){return"list"+e.name+"s"},O[n.CREATE]=function(e){return"create"+e.name},O[n.UPDATE]=function(e){return"update"+e.name},O[n.DELETE]=function(e){return"delete"+e.name},O),exclude:void 0,include:void 0}},L=function(e){var i=e.queries,o=e.mutations,l=e.schema,d=b(e,["queries","mutations","schema"]),f=function(e){var r=e.auth,t=c.createHttpLink({uri:e.endpoint}),n=a.createAppSyncLink(r),i=new s.IntrospectionFragmentMatcher({introspectionQueryResultData:{__schema:{types:[]}}});return new u.ApolloClient({link:n.concat(t),cache:new s.InMemoryCache({fragmentMatcher:i})})}(I({},d)),p=C({queries:i,mutations:o,schema:l}),m=r({client:f,buildQuery:p},R,d,{introspection:{schema:l.data.__schema}});return t(m).then((function(e){return function(r,t,i){var o=b(i,["ids"]);switch(console.log("FETCH TYPE: "+r),r){case n.DELETE_MANY:return Promise.all(i.ids.map((function(n){return e(j[r],t,I({id:n},o))}))).then((function(e){return{data:e.reduce((function(e,r,t){return[].concat(e,[i.ids[t]])}),[])}}));case n.UPDATE_MANY:case n.GET_MANY:return Promise.all(i.ids.map((function(n){return e(j[r],t,I({id:n},o))}))).then((function(e){return{data:r===n.GET_MANY?e.map((function(e){return e.data})):e.reduce((function(e,r){return[].concat(e,[r.data.id])}),[])}}));default:return e(r,t,i)}}}))};function D(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var U=d.createContext(void 0),Y=d.createContext(void 0);function M(){return l.useContext(Y)}var G=function(e,r){return void 0===e&&(e=null),r.type===A.CRUD_GET_LIST_SUCCESS?r.payload.nextToken||null:e},F=function(e){var r=e.source,t=e.record,n=void 0===t?{}:t,i=e.children,o=b(e,["source","record","children"]),a=d.useState(),u=a[0],c=a[1],s=r&&"object"==typeof n[r]?n[r]:n,l=s.key,f=s.identityId,p=s.level;if(d.useEffect((function(){l&&!l.match(/blob|http/i)&&y.Storage.get(l,"protected"===p||"private"===p?{level:p,identityId:f}:{}).then((function(e){return c(e)}))}),[l,p,f]),!u&&l)return d.createElement(v.CircularProgress,{"data-testid":"s3-object-loading"});if(u){var m=I({record:n,source:r,src:u},o);return d.cloneElement(i,m)}return null};F.defaultProps={addLabel:!0};var H=v.makeStyles((function(e){return{icon:{marginRight:e.spacing(1)}}})),K=function(e){var r=e.record,t=e.source,n=r&&t&&r[t]||r,i=function(e){switch(e){case"image/png":case"image/gif":case"image/jpeg":case"image/jpg":return P;case"video/mp4":case"video/3gpp":case"video/quicktime":case"video/x-msvideo":return _;default:return k}}(n.type),o=H();return d.createElement(d.Fragment,null,d.createElement(i,{titleAccess:"Icon for file type "+(n.type||"unknown"),className:o.icon}),d.createElement(v.Link,{href:n.key,title:"Open "+n.key,target:"_blank"},n.key+(n.level?" - "+n.level:"")))},B=function(e){return d.createElement(F,Object.assign({},e),d.createElement(K,null))},z=function(e){var r=e.src,t=e.record,n=e.source,i=t&&n&&t[n]||t;return i&&r?d.createElement("img",Object.assign({src:r,title:i.key},e.imgProps)):null},J=function(e){var r=e.imgProps,t=void 0===r?{}:r,n=b(e,["imgProps"]);return d.createElement(F,Object.assign({},n),d.createElement(z,{imgProps:t}))};J.defaultProps={addLabel:!0};var Q=function(e){var r=e.source,t=e.dropzoneOptions,n=void 0===t?{}:t,i=e.level,o=e.children,a=b(e,["source","dropzoneOptions","level","children"]),u=A.usePermissions().permissions,c=A.useInput({source:r}).input,s=A.useNotify(),l=I({source:r,options:I({onDrop:function(e){try{var r=D((function(){return Promise.resolve(Promise.all(e.map((function(e){var r=e.name.split(".");return y.Storage.put(r[0]+"-"+S.uuid().split("-").slice(0,2).join("-")+"."+r[1],e).then((function(r){var t={key:r.key,type:e.type,level:null,identityId:null};return"protected"!==i&&"private"!==i||(t.identityId=u.claims.identityId,t.level=i),t}))})))).then((function(e){c.onChange(a.multiple?e:e[0])}))}),(function(){c.onChange(void 0),s("There was an error uploading your files.")}));return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}},n)},a);return d.cloneElement(o,l)},Z=v.makeStyles({fileInput:{"& .previews > div":{display:"flex",alignItems:"center"}}}),V={nextToken:G};exports.AmplifyAuthProvider=function(e){var r=e.children,t=l.useState(void 0),n=t[0],i=t[1];return l.useEffect((function(){!function(){try{var e=D((function(){return Promise.resolve(f.currentAuthenticatedUser()).then((function(e){i("not authenticated"===e?void 0:e)}))}),(function(){}));e&&e.then&&e.then((function(){}))}catch(e){Promise.reject(e)}}();var e=function(e){var r=e.payload;try{var t=function(){if("signIn"===r.event){var e=D((function(){return Promise.resolve(f.currentAuthenticatedUser()).then((function(e){i(e)}))}),(function(){}));if(e&&e.then)return e.then((function(){}))}else"signOut"===r.event&&i(void 0)}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}};return p.Hub.listen("auth",e),function(){p.Hub.remove("auth",e)}}),[]),d.createElement(U.Provider,{value:f},d.createElement(Y.Provider,{value:n},r))},exports.AmplifyPagination=function(e){var r=T.useSelector((function(e){return e.nextToken}));return 1!==e.page||r?d.createElement(g,null,e.page>1&&d.createElement(v.Button,{color:"primary",key:"prev",startIcon:d.createElement(E,null),onClick:function(){return e.setPage(e.page-1)}},"Prev"),r&&d.createElement(v.Button,{color:"primary",key:"next",endIcon:d.createElement(h,null),onClick:function(){return e.setPage(e.page+1)}},"Next")):null},exports.NOT_INSIDE_AMPLIFY_PROVIDER="No AuthenticationContext. Did you forget to wrap your app in <AmplifyProvider />?",exports.S3Field=F,exports.S3FileField=B,exports.S3FileInput=function(e){var r=Z();return d.createElement(Q,Object.assign({},e),d.createElement(A.FileInput,{className:r.fileInput},d.createElement(B,{source:e.source})))},exports.S3ImageField=J,exports.S3ImageInput=function(e){return d.createElement(Q,Object.assign({},e),d.createElement(A.ImageInput,null,d.createElement(J,{source:e.source})))},exports.S3Input=Q,exports.buildAmplifyProvider=L,exports.nextTokenReducer=G,exports.reducers=V,exports.useAmplifyDataProvider=function(e){var r=e.config,t=e.schema,n=e.queries,i=e.mutations,o=e.authType,a=void 0===o?void 0:o,u=l.useState(),c=u[0],s=u[1],d=M(),f=a||r.aws_appsync_authenticationType;return l.useEffect((function(){(function(e){try{var o=function(e,r){switch(r||e.aws_appsync_authenticationType||m.AUTH_TYPE.NONE){case m.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS:return{type:m.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS,jwtToken:function(){try{return Promise.resolve(D((function(){return Promise.resolve(y.Auth.currentSession()).then((function(e){return e.getAccessToken().getJwtToken()}))}),(function(e){return console.log("error with jwt",e),Promise.reject("Unauthorized")})))}catch(e){return Promise.reject(e)}}};case m.AUTH_TYPE.API_KEY:return{type:m.AUTH_TYPE.API_KEY,apiKey:e.aws_appsync_apiKey};case m.AUTH_TYPE.NONE:default:return{type:m.AUTH_TYPE.NONE}}}(r,e);return Promise.resolve(L({endpoint:r.aws_appsync_graphqlEndpoint,auth:{url:r.aws_appsync_graphqlEndpoint,region:r.aws_appsync_region,auth:o},schema:t,queries:n,mutations:i}))}catch(e){return Promise.reject(e)}})(f).then((function(e){return s((function(){return e}))}))}),[d,f]),c},exports.useAuth=function(){var e=l.useContext(U);if(!e)throw Error("No AuthenticationContext. Did you forget to wrap your app in <AmplifyProvider />?");return e},exports.useAuthProvider=function(){return{login:function(e){var r=e.username,t=e.password,n=e.provider;return r&&t&&!n?f.signIn(r,t):f.federatedSignIn({provider:n})},logout:function(){return f.signOut()},checkAuth:function(){return f.currentSession()},checkError:function(){return f.currentCredentials()},getPermissions:function(){return Promise.all([f.currentSession(),f.currentCredentials()]).then((function(e){var r=e[1].identityId;return{claims:I({},e[0].getIdToken().payload,{identityId:r})}}))}}},exports.useUser=M;
//# sourceMappingURL=ra-aws-amplify.cjs.production.min.js.map
